<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BBH22 ‚Äî Ultimate Tic Tac Trivia</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
  --bg: #f0f4f8;
  --surface: #dce8f5;
  --border: #b0c8e0;
  --text: #1a1a2e;
  --muted: #5a6a80;
  --accent: #2a7de1;
  --p1: #e85d5d;
  --p2: #5d9ee8;
}
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: var(--bg); color: var(--text); font-family: 'DM Sans', sans-serif; min-height: 100vh; overflow-x: hidden; }

  /* ===== SETUP ===== */
  #setup-screen {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    min-height: 100vh; padding: 40px 20px;
    background: #f0f4f8;
  }
  .setup-title { font-family: 'Bebas Neue', sans-serif; font-size: clamp(48px,8vw,96px); letter-spacing: 6px; color: #2a7de1; text-align: center; line-height: 1; margin-bottom: 8px; text-shadow: none; }
  .setup-subtitle { font-size: 13px; letter-spacing: 4px; text-transform: uppercase; color: var(--muted); margin-bottom: 48px; }
  .setup-card { background: #ffffff; border: 1px solid #b0c8e0; border-radius: 16px; padding: 40px; width: 100%; max-width: 640px; display: flex; flex-direction: column; gap: 32px; }
  .players-row { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
  .player-setup { display: flex; flex-direction: column; gap: 12px; }
  .player-label { font-family: 'Bebas Neue', sans-serif; font-size: 22px; letter-spacing: 3px; }
  .player-label.p1 { color: var(--p1); }
  .player-label.p2 { color: var(--p2); }
  .setup-input { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 12px 14px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 15px; transition: border-color 0.2s; width: 100%; }
  .setup-input:focus { outline: none; border-color: var(--accent); }
  .color-row { display: flex; align-items: center; gap: 10px; }
  .color-preview { width: 32px; height: 32px; border-radius: 6px; border: 1px solid var(--border); flex-shrink: 0; }
  .start-btn { background: var(--accent); color: #0a0a0f; border: none; border-radius: 10px; padding: 16px 32px; font-family: 'Bebas Neue', sans-serif; font-size: 22px; letter-spacing: 3px; cursor: pointer; transition: transform 0.15s, box-shadow 0.15s; align-self: stretch; }
  .start-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(240,192,64,0.35); }

  /* ===== GAME SCREEN ===== */
  #game-screen { display: none; flex-direction: column; min-height: 100vh; padding: 12px 16px; gap: 10px; }
  .game-header { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px; }
  .player-badge { display: flex; align-items: center; gap: 10px; padding: 8px 16px; border-radius: 8px; border: 2px solid transparent; transition: all 0.3s; }
  .player-badge.active { border-color: var(--player-color, var(--accent)); background: color-mix(in srgb, var(--player-color, var(--accent)) 12%, transparent); box-shadow: 0 0 20px color-mix(in srgb, var(--player-color, var(--accent)) 30%, transparent); }
  .badge-dot { width: 12px; height: 12px; border-radius: 50%; }
  .badge-name { font-family: 'Bebas Neue', sans-serif; font-size: 20px; letter-spacing: 2px; }
  .badge-score { font-size: 13px; color: var(--muted); font-weight: 600; }
  .turn-indicator { font-family: 'Bebas Neue', sans-serif; font-size: 13px; letter-spacing: 4px; text-transform: uppercase; color: var(--muted); text-align: center; }
  .turn-name { font-size: 18px; display: block; }

  /* ===== MEGA GRID ===== */
  .grid-wrapper { overflow: auto; flex: 1; }
  .mega-grid {
    display: grid;
    grid-template-columns: 110px 1fr 1fr 1fr 4px 1fr 1fr 1fr 4px 1fr 1fr 1fr;
    grid-template-rows: auto 1fr 1fr 1fr 4px 1fr 1fr 1fr 4px 1fr 1fr 1fr;
    min-width: 860px;
    gap: 2px;
  }

  .corner-cell { background: transparent; }
  .macro-divider-col { background: #2a7de1; opacity: 1; border-radius: 2px; }
  .macro-divider-row { background: #2a7de1; opacity: 1; border-radius: 2px; }

  .col-header {
    background: #c8dff5; border: 1px solid var(--border); border-radius: 5px;
    padding: 6px 4px; font-size: 9px; font-weight: 600; letter-spacing: 0.3px;
    text-align: center; color: #1a2a3a; line-height: 1.3;
    display: flex; align-items: center; justify-content: center;
  }
  .col-header.macro-group-start { border-top: 2px solid var(--accent); }

  .row-header {
    background: #c8dff5; border: 1px solid var(--border); border-radius: 5px;
    padding: 6px 8px; font-size: 9px; font-weight: 600; letter-spacing: 0.3px;
    color: #1a2a3a; line-height: 1.3; display: flex; align-items: center;
  }
  .row-header.macro-group-start { border-left: 2px solid var(--accent); }

  .grid-cell {
    background: var(--surface); border: 1px solid #b0c8e0; border-radius: 5px;
    aspect-ratio: 1; cursor: pointer; position: relative; overflow: hidden;
    transition: transform 0.12s, border-color 0.15s; min-height: 55px;
  }
  .grid-cell:hover:not(.claimed):not(.locked) { transform: scale(1.05); border-color: var(--accent); z-index: 10; }
  .grid-cell.selectable { border-color: var(--accent) !important; animation: pulse 1.6s ease-in-out infinite; }
  @keyframes pulse { 0%,100% { box-shadow: 0 0 6px rgba(240,192,64,0.2); } 50% { box-shadow: 0 0 18px rgba(240,192,64,0.55); } }
  .grid-cell.locked { cursor: not-allowed; opacity: 0.35; }
  .grid-cell.claimed { cursor: default; }
  .cell-photo { width: 100%; height: 100%; object-fit: cover; position: absolute; inset: 0; }
  .cell-gradient { position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.75) 0%, transparent 55%); pointer-events: none; }
  .cell-name { position: absolute; bottom: 3px; left: 0; right: 0; text-align: center; font-size: 8px; font-weight: 700; letter-spacing: 0.5px; color: #fff; text-shadow: 0 1px 4px rgba(0,0,0,0.9); pointer-events: none; }
  .cell-border-overlay { position: absolute; inset: 0; border-radius: 5px; border: 3px solid var(--claim-color, transparent); pointer-events: none; }

  /* Mini-grid won tint */
  .mini-won-overlay {
    position: absolute; inset: 0; border-radius: 5px; pointer-events: none; z-index: 15;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Bebas Neue', sans-serif; font-size: 11px; letter-spacing: 1px;
  }

  /* ===== MODAL ===== */
  #modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(6px); }
  #modal-overlay.open { display: flex; }
  .modal { background: #ffffff; border: 1px solid #b0c8e0; border-radius: 20px; padding: 28px; width: 92%; max-width: 480px; display: flex; flex-direction: column; gap: 18px; animation: modal-in 0.22s ease; max-height: 90vh; overflow-y: auto; }
  @keyframes modal-in { from { transform: translateY(16px) scale(0.97); opacity: 0; } to { transform: none; opacity: 1; } }

  .modal-cats { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .modal-cat { background: #eaf2ff; border-radius: 8px; padding: 10px 12px; font-size: 11px; font-weight: 600; color: #1a2a3a; line-height: 1.4; }
  .modal-cat span { display: block; font-size: 9px; text-transform: uppercase; letter-spacing: 1px; color: var(--accent); margin-bottom: 3px; }

  .modal-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--muted); margin-bottom: 6px; }

  /* Dropdown */
  .answer-select { width: 100%; background: #eaf2ff; border: 1px solid var(--border); border-radius: 10px; padding: 12px 14px; color: #1a2a3a; font-family: 'DM Sans', sans-serif; font-size: 15px; cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23666680' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 14px center; padding-right: 36px; }
  .answer-select:focus { outline: none; border-color: var(--accent); }
  .answer-select option { background: #1e1e2e; }

  /* Cast roster inside modal */
  .cast-roster { display: flex; flex-wrap: wrap; gap: 6px; }
  .cast-tag {
    padding: 5px 10px; border-radius: 20px; font-size: 11px; font-weight: 600;
    background: #eaf2ff; border: 1px solid #b0c8e0; color: #1a2a3a;
    transition: all 0.15s; white-space: nowrap;
  }
  .cast-tag.strikeout { text-decoration: line-through; opacity: 0.35; color: var(--muted); }

  .modal-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .btn-submit { background: var(--accent); color: #0a0a0f; border: none; border-radius: 10px; padding: 14px; font-family: 'Bebas Neue', sans-serif; font-size: 20px; letter-spacing: 2px; cursor: pointer; grid-column: 1 / -1; transition: opacity 0.2s; }
  .btn-submit:hover { opacity: 0.88; }
  .btn-cancel { background: transparent; color: var(--muted); border: 1px solid var(--border); border-radius: 10px; padding: 10px; font-family: 'DM Sans', sans-serif; font-size: 13px; cursor: pointer; grid-column: 1 / -1; }

  /* Correct flash */
  .modal-correct { text-align: center; font-family: 'Bebas Neue', sans-serif; font-size: 52px; letter-spacing: 4px; padding: 20px 0; animation: correct-pop 0.4s ease; }
  @keyframes correct-pop { 0% { transform: scale(0.7); opacity: 0; } 70% { transform: scale(1.08); } 100% { transform: scale(1); opacity: 1; } }

  /* ===== WIN SCREEN ===== */
  #win-screen { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.93); z-index: 200; align-items: center; justify-content: center; flex-direction: column; gap: 20px; text-align: center; }
  #win-screen.open { display: flex; }
  .win-title { font-family: 'Bebas Neue', sans-serif; font-size: clamp(60px,12vw,120px); letter-spacing: 8px; line-height: 1; }
  .win-sub { font-size: 15px; color: var(--muted); letter-spacing: 3px; text-transform: uppercase; }
  .win-restart { background: var(--accent); color: #0a0a0f; border: none; border-radius: 10px; padding: 14px 36px; font-family: 'Bebas Neue', sans-serif; font-size: 22px; letter-spacing: 3px; cursor: pointer; margin-top: 16px; }
</style>
</head>
<body>

<!-- ========== SETUP ========== -->
<div id="setup-screen">
  <div class="setup-title">BBH22</div>
  <div class="setup-subtitle">Ultimate Tic Tac Trivia ¬∑ Season Trivia</div>
  <div class="setup-card">
    <div class="players-row">
      <div class="player-setup">
        <div class="player-label p1">Player 1</div>
        <input class="setup-input" id="p1-name" type="text" placeholder="Enter name..." value="Player 1">
        <div class="color-row">
          <div class="color-preview" id="p1-preview" style="background:#e85d5d"></div>
          <input class="setup-input" id="p1-color" type="text" placeholder="#e85d5d" value="#e85d5d">
        </div>
      </div>
      <div class="player-setup">
        <div class="player-label p2">Player 2</div>
        <input class="setup-input" id="p2-name" type="text" placeholder="Enter name..." value="Player 2">
        <div class="color-row">
          <div class="color-preview" id="p2-preview" style="background:#5d9ee8"></div>
          <input class="setup-input" id="p2-color" type="text" placeholder="#5d9ee8" value="#5d9ee8">
        </div>
      </div>
    </div>
    <button class="start-btn" onclick="startGame()">START COMPETITION</button>
  </div>
</div>

<!-- ========== GAME ========== -->
<div id="game-screen">
  <div class="game-header">
    <div class="player-badge" id="badge-p1">
      <div class="badge-dot" id="dot-p1" style="background:var(--p1)"></div>
      <div class="badge-name" id="name-p1">Player 1</div>
      <div class="badge-score">üèÜ <span id="score-p1">0</span>/3</div>
    </div>
    <div style="text-align:center">
      <div class="turn-indicator">CURRENT TURN<span class="turn-name" id="turn-display">‚Äî</span></div>
    </div>
    <div class="player-badge" id="badge-p2">
      <div class="badge-dot" id="dot-p2" style="background:var(--p2)"></div>
      <div class="badge-name" id="name-p2">Player 2</div>
      <div class="badge-score">üèÜ <span id="score-p2">0</span>/3</div>
    </div>
  </div>
  <div class="grid-wrapper">
    <div class="mega-grid" id="mega-grid"></div>
  </div>
</div>

<!-- ========== MODAL ========== -->
<div id="modal-overlay">
  <div class="modal" id="modal-box">
    <div id="modal-inner">
      <div class="modal-cats">
        <div class="modal-cat"><span>Column</span><span id="modal-col-cat"></span></div>
        <div class="modal-cat"><span>Row</span><span id="modal-row-cat"></span></div>
      </div>
      <div>
        <div class="modal-label">Cast Members</div>
        <div class="cast-roster" id="cast-roster"></div>
      </div>
      <div>
        <div class="modal-label">Select a Cast Member</div>
        <select class="answer-select" id="answer-select">
          <option value="">‚Äî choose ‚Äî</option>
        </select>
      </div>
      <div class="modal-btns">
        <button class="btn-submit" onclick="submitAnswer()">SUBMIT ANSWER</button>
        <button class="btn-cancel" onclick="closeModal()">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- ========== WIN ========== -->
<div id="win-screen">
  <div class="win-title" id="win-name">PLAYER 1</div>
  <div class="win-sub">wins Ultimate Tic Tac Trivia!</div>
  <button class="win-restart" onclick="location.reload()">PLAY AGAIN</button>
</div>

<script>
// ============================================================
// CAST & DATA
// ============================================================
const ALL_CAST = ["BENJI","BRANDON","CASEY","CHRIS","DREW","ERIN","GENKI","JACOB","JOHNNY","JULIA","RAYA","ROY","SHANNON","SIMONA","STEPH"];

const CAST_PHOTOS = {
  "BENJI":   "",
  "BRANDON": "",
  "CASEY":   "",
  "CHRIS":   "",
  "DREW":    "",
  "ERIN":    "",
  "GENKI":   "",
  "JACOB":   "",
  "JOHNNY":  "",
  "JULIA":   "",
  "RAYA":    "",
  "ROY":     "",
  "SHANNON": "",
  "SIMONA":  "",
  "STEPH":   ""
};

const COL_CATS = [
  "INITIAL NOM AT LEAST ONCE",
  "DID NOT WIN A POV",
  "RECEIVED AT LEAST 1 VOTE TO EVICT",
  "COMPETED IN 6+ PREJURY COMPS",
  "NEVER WON CHALLENGES BACK-TO-BACK",
  "NEVER A NOMINEE ON LIVE NIGHT",
  "IN THE SAME HOUSE 3 CONSECUTIVE ROUNDS",
  "NOMINATED AFTER WINNING HOH",
  "CAST AN EVICTION VOTE 3 CONSECUTIVE ROUNDS"
];

const ROW_CATS = [
  "WON AT LEAST ONE CHALLENGE",
  "TOP 3 ‚â•3 TIMES IN CHALLENGES",
  "IN BOTH HOUSES ‚â•2 TIMES",
  "COMPETED IN AT LEAST 1 LIVE NIGHT POV",
  "SCORED ABOVE 0 IN TRAIN OF THOUGHT",
  "NEVER A FINAL NOMINEE IN THE PREJURY",
  "PLACED LAST IN AT LEAST 1 CHALLENGE",
  "SECOND PLACE IN AT LEAST 1 CHALLENGE",
  "RECEIVED AN EVEN NUMBER OF VOTES TO EVICT"
];

const VALID_ANSWERS = [
  [["BENJI","BRANDON","CHRIS","DREW","GENKI","JACOB","JOHNNY","RAYA","ROY","SIMONA","STEPH"],["BRANDON","CHRIS","JOHNNY","JULIA","RAYA","ROY","SIMONA","STEPH"],["BENJI","BRANDON","CHRIS","GENKI","JACOB","JOHNNY","JULIA","RAYA","ROY","STEPH"],["BENJI","CHRIS","DREW","GENKI","JACOB","JOHNNY","JULIA","RAYA","ROY","STEPH"],["BRANDON","CHRIS","JACOB","JOHNNY","JULIA","RAYA","ROY","SIMONA","STEPH"],["BENJI","BRANDON","CHRIS","JACOB","JULIA","SHANNON"],["BENJI","BRANDON","CHRIS","JACOB","JOHNNY","RAYA","ROY","SIMONA","STEPH"],["BENJI","BRANDON","CHRIS","JACOB","JOHNNY","RAYA","ROY","SIMONA","STEPH"],["BENJI","BRANDON","DREW","GENKI","JACOB","JOHNNY","RAYA","ROY","SIMONA","STEPH"]],
  [["BENJI","BRANDON","DREW","ERIN","GENKI","JACOB","JOHNNY","RAYA","SIMONA","STEPH"],["BRANDON","ERIN","JOHNNY","JULIA","RAYA","SIMONA","STEPH"],["BENJI","BRANDON","ERIN","GENKI","JACOB","JOHNNY","RAYA","SIMONA","STEPH"],["BENJI","DREW","GENKI","JACOB","JOHNNY","JULIA","RAYA","STEPH"],["BRANDON","ERIN","JACOB","JOHNNY","JULIA","RAYA","SIMONA","STEPH"],["BENJI","BRANDON","ERIN","JACOB","JULIA"],["BENJI","BRANDON","JACOB","JOHNNY","RAYA","SIMONA","STEPH"],["BENJI","BRANDON","DREW","GENKI","JOHNNY","RAYA","SIMONA","STEPH"],["BENJI","BRANDON","DREW","GENKI","JACOB","JOHNNY","RAYA","SIMONA","STEPH"]],
  [["BENJI","BRANDON","CHRIS","DREW","GENKI","JACOB","JOHNNY","SIMONA","STEPH"],["BRANDON","CHRIS","JOHNNY","JULIA","SHANNON","SIMONA","STEPH"],["BENJI","BRANDON","CHRIS","GENKI","JACOB","JOHNNY","JULIA","SHANNON","STEPH"],["BENJI","CHRIS","DREW","GENKI","JACOB","JOHNNY","JULIA","STEPH"],["BRANDON","CHRIS","JACOB","JOHNNY","JULIA","ROY","SIMONA","STEPH"],["BENJI","BRANDON","CHRIS","JACOB","JULIA"],["BENJI","BRANDON","CHRIS","JACOB","JOHNNY","RAYA","SIMONA"],["BENJI","BRANDON","DREW","GENKI","JOHNNY","SIMONA","STEPH"],["BENJI","BRANDON","DREW","GENKI","JACOB","SIMONA","STEPH"]],
  [["BENJI","BRANDON","DREW","GENKI","JACOB","JOHNNY","RAYA","ROY","SIMONA"],["BRANDON","JOHNNY","RAYA","ROY","SIMONA","STEPH"],["BENJI","BRANDON","GENKI","JACOB","JOHNNY","RAYA","ROY","STEPH"],["BENJI","DREW","GENKI","JACOB","JOHNNY","RAYA","ROY"],["BRANDON","ERIN","JACOB","JOHNNY","JULIA","ROY","SIMONA","STEPH"],["BENJI","BRANDON","JACOB","JOHNNY"],["BENJI","BRANDON","JACOB","JOHNNY","RAYA","SIMONA"],["BENJI","BRANDON","DREW","GENKI","RAYA","SIMONA"],["BENJI","BRANDON","DREW","GENKI","JACOB","SIMONA"]],
  [["BENJI","BRANDON","CASEY","DREW","ERIN","GENKI","JACOB","JOHNNY","ROY"],["BRANDON","CASEY","ERIN","JOHNNY","JULIA","ROY","SIMONA","STEPH"],["BENJI","BRANDON","CASEY","ERIN","GENKI","JACOB","JOHNNY","JULIA","ROY","SIMONA","STEPH"],["BENJI","DREW","GENKI","JACOB","JOHNNY","JULIA","ROY"],["BRANDON","CASEY","ERIN","JACOB","JOHNNY","JULIA","ROY","SIMONA","STEPH"],["BENJI","BRANDON","CASEY","JACOB","JULIA"],["BENJI","BRANDON","CASEY","JACOB","JOHNNY","ROY","SIMONA"],["BENJI","BRANDON","DREW","GENKI","ROY","SIMONA"],["BENJI","BRANDON","CASEY","DREW","GENKI","JACOB","SIMONA"]],
  [["BENJI","BRANDON","CASEY","DREW","JACOB","JOHNNY","RAYA","SIMONA","STEPH"],["BRANDON","CASEY","JOHNNY","JULIA","RAYA","SIMONA","STEPH"],["BENJI","BRANDON","CASEY","JACOB","JOHNNY","JULIA","RAYA","SIMONA","STEPH"],["BENJI","DREW","JACOB","JOHNNY","JULIA","RAYA"],["BRANDON","CASEY","JACOB","JOHNNY","JULIA","RAYA","SIMONA","STEPH"],["BENJI","BRANDON","CASEY","CHRIS","JACOB"],["BENJI","BRANDON","CASEY","JACOB","JOHNNY","RAYA","SIMONA"],["BENJI","BRANDON","DREW","RAYA","STEPH"],["BENJI","BRANDON","CASEY","DREW","JACOB","RAYA","STEPH"]],
  [["BENJI","BRANDON","CASEY","CHRIS","GENKI","JACOB","JOHNNY","RAYA","STEPH"],["BRANDON","CASEY","CHRIS","JOHNNY","RAYA","STEPH"],["BENJI","BRANDON","CASEY","CHRIS","GENKI","JACOB","JOHNNY","RAYA","STEPH"],["BENJI","CHRIS","GENKI","JACOB","JOHNNY","RAYA"],["BRANDON","CASEY","CHRIS","JACOB","JOHNNY","ROY","SIMONA","STEPH"],["BENJI","BRANDON","CASEY","CHRIS","JACOB"],["BENJI","BRANDON","CASEY","CHRIS","JACOB","JOHNNY","RAYA","SIMONA"],["BENJI","BRANDON","CASEY","GENKI","RAYA","SIMONA"],["BENJI","BRANDON","CASEY","GENKI","JACOB","SIMONA"]],
  [["BENJI","BRANDON","DREW","ERIN","GENKI","JOHNNY","RAYA","SIMONA"],["BRANDON","ERIN","JOHNNY","JULIA","RAYA","SIMONA","STEPH"],["BENJI","BRANDON","DREW","ERIN","GENKI","JOHNNY","JULIA","SIMONA","STEPH"],["BENJI","DREW","GENKI","JOHNNY","JULIA","RAYA"],["BRANDON","ERIN","JOHNNY","JULIA","RAYA","SIMONA","STEPH"],["BENJI","BRANDON","ERIN","JULIA"],["BENJI","BRANDON","JOHNNY","RAYA","SIMONA"],["BENJI","BRANDON","DREW","GENKI","SIMONA","STEPH"],["BENJI","BRANDON","DREW","GENKI","JOHNNY","RAYA","SIMONA","STEPH"]],
  [["BRANDON","CASEY","DREW","GENKI","JACOB","ROY","SIMONA","STEPH"],["BRANDON","CASEY","JULIA","ROY","SIMONA","STEPH"],["BRANDON","GENKI","JACOB","JULIA","ROY","STEPH"],["DREW","GENKI","JACOB","JULIA","ROY","STEPH"],["BRANDON","CASEY","JACOB","JULIA","ROY","SIMONA","STEPH"],["BRANDON","CASEY","JACOB","JULIA"],["BENJI","BRANDON","CASEY","GENKI","JACOB","SIMONA","STEPH"],["BENJI","BRANDON","DREW","GENKI","ROY","SIMONA","STEPH"],["BRANDON","CASEY","DREW","GENKI","JACOB","SIMONA","STEPH"]]
];

// ============================================================
// GAME STATE
// ============================================================
let players = [{name:"Player 1",color:"#e85d5d"},{name:"Player 2",color:"#5d9ee8"}];
let board, miniWon, currentPlayer, scores, forcedMacro, activeCell;
// wrongGuesses[r][c] = Set of names guessed wrong
let wrongGuesses;

function initState() {
  board = Array.from({length:9},()=>Array(9).fill(null));
  miniWon = Array.from({length:3},()=>Array(3).fill(null));
  currentPlayer = 0;
  scores = [0,0];
  forcedMacro = null;
  activeCell = null;
  wrongGuesses = Array.from({length:9},()=>Array.from({length:9},()=>new Set()));
}

// ============================================================
// SETUP
// ============================================================
document.getElementById('p1-color').addEventListener('input',e=>{ document.getElementById('p1-preview').style.background=e.target.value; });
document.getElementById('p2-color').addEventListener('input',e=>{ document.getElementById('p2-preview').style.background=e.target.value; });

function startGame() {
  players[0].name = document.getElementById('p1-name').value||'Player 1';
  players[0].color = document.getElementById('p1-color').value||'#e85d5d';
  players[1].name = document.getElementById('p2-name').value||'Player 2';
  players[1].color = document.getElementById('p2-color').value||'#5d9ee8';
  document.documentElement.style.setProperty('--p1',players[0].color);
  document.documentElement.style.setProperty('--p2',players[1].color);
  document.getElementById('name-p1').textContent = players[0].name;
  document.getElementById('name-p2').textContent = players[1].name;
  document.getElementById('dot-p1').style.background = players[0].color;
  document.getElementById('dot-p2').style.background = players[1].color;
  document.getElementById('badge-p1').style.setProperty('--player-color',players[0].color);
  document.getElementById('badge-p2').style.setProperty('--player-color',players[1].color);
  document.getElementById('setup-screen').style.display='none';
  document.getElementById('game-screen').style.display='flex';
  initState();
  buildGrid();
  updateUI();
}

// ============================================================
// GRID ‚Äî uses extra divider columns/rows for visible separators
// ============================================================
// col indices in CSS grid: 0=row-header, 1-3=macro-col-0, 4=divider, 5-7=macro-col-1, 8=divider, 9-11=macro-col-2
// row indices: 0=col-headers, 1-3=macro-row-0, 4=divider, 5-7=macro-row-1, 8=divider, 9-11=macro-row-2

function gameColToGridCol(c) { return 1 + c + Math.floor(c/3); }
function gameRowToGridRow(r) { return 1 + r + Math.floor(r/3); }

function buildGrid() {
  const grid = document.getElementById('mega-grid');
  grid.innerHTML = '';

  const TOTAL_COLS = 12; // 1 header + 9 data + 2 dividers
  const TOTAL_ROWS = 12;

  // We'll place items using grid-column / grid-row on each element
  // Corner
  const corner = document.createElement('div');
  corner.className = 'corner-cell';
  corner.style.gridColumn = '1';
  corner.style.gridRow = '1';
  grid.appendChild(corner);

  // Column dividers (visual separators between macro grids)
  [5,9].forEach(gc => {
    const d = document.createElement('div');
    d.className = 'macro-divider-col';
    d.style.gridColumn = gc;
    d.style.gridRow = `1 / ${TOTAL_ROWS+1}`;
    grid.appendChild(d);
  });

  // Row dividers
  [5,9].forEach(gr => {
    const d = document.createElement('div');
    d.className = 'macro-divider-row';
    d.style.gridRow = gr;
    d.style.gridColumn = `1 / ${TOTAL_COLS+1}`;
    grid.appendChild(d);
  });

  // Column headers
  for (let c = 0; c < 9; c++) {
    const h = document.createElement('div');
    h.className = 'col-header' + (c%3===0?' macro-group-start':'');
    h.style.gridColumn = gameColToGridCol(c);
    h.style.gridRow = '1';
    h.textContent = COL_CATS[c];
    grid.appendChild(h);
  }

  // Row headers + cells
  for (let r = 0; r < 9; r++) {
    const gr = gameRowToGridRow(r);
    const rh = document.createElement('div');
    rh.className = 'row-header' + (r%3===0?' macro-group-start':'');
    rh.style.gridColumn = '1';
    rh.style.gridRow = gr;
    rh.textContent = ROW_CATS[r];
    grid.appendChild(rh);

    for (let c = 0; c < 9; c++) {
      const cell = document.createElement('div');
      cell.className = 'grid-cell';
      cell.id = `cell-${r}-${c}`;
      cell.dataset.row = r; cell.dataset.col = c;
      cell.style.gridColumn = gameColToGridCol(c);
      cell.style.gridRow = gr;
      cell.addEventListener('click', ()=>onCellClick(r,c));
      grid.appendChild(cell);
    }
  }
}

// ============================================================
// UI UPDATE
// ============================================================
function updateUI() {
  document.getElementById('turn-display').textContent = players[currentPlayer].name;
  document.getElementById('turn-display').style.color = players[currentPlayer].color;
  document.getElementById('badge-p1').classList.toggle('active', currentPlayer===0);
  document.getElementById('badge-p2').classList.toggle('active', currentPlayer===1);
  document.getElementById('score-p1').textContent = scores[0];
  document.getElementById('score-p2').textContent = scores[1];

  for (let r=0;r<9;r++) {
    for (let c=0;c<9;c++) {
      const cell = document.getElementById(`cell-${r}-${c}`);
      cell.classList.remove('selectable','locked');
      const mr=Math.floor(r/3), mc=Math.floor(c/3);
      if (!board[r][c]) {
        if (miniWon[mr][mc]!==null) { cell.classList.add('locked'); }
        else if (forcedMacro===null) { cell.classList.add('selectable'); }
        else if (mr===forcedMacro.mr && mc===forcedMacro.mc) { cell.classList.add('selectable'); }
        else { cell.classList.add('locked'); }
      }
    }
  }
}

// ============================================================
// CELL CLICK
// ============================================================
function onCellClick(r,c) {
  const cell = document.getElementById(`cell-${r}-${c}`);
  if (!cell.classList.contains('selectable')) return;
  activeCell = {r,c};
  document.getElementById('modal-col-cat').textContent = COL_CATS[c];
  document.getElementById('modal-row-cat').textContent = ROW_CATS[r];
  buildModalCastList(r,c);
  document.getElementById('modal-inner').style.display='';
  document.getElementById('modal-overlay').classList.add('open');
}

// ============================================================
// BUILD MODAL CAST LIST & DROPDOWN
// ============================================================
function buildModalCastList(r,c) {
  const mr=Math.floor(r/3), mc=Math.floor(c/3);
  // Names used in this mini-grid (can only be used once per correct guess per cell, but same player can appear in multiple cells)
  // Strikeout rules:
  // 1) guessed wrong for THIS cell
  // 2) used 2x in this 3x3 grid  (count claims in mini grid)
  const miniUsed = {};
  for (let i=0;i<3;i++) for (let j=0;j<3;j++) {
    const d = board[mr*3+i][mc*3+j];
    if (d) { miniUsed[d.name] = (miniUsed[d.name]||0)+1; }
  }

  const roster = document.getElementById('cast-roster');
  roster.innerHTML = '';
  const sel = document.getElementById('answer-select');
  sel.innerHTML = '<option value="">‚Äî choose ‚Äî</option>';

  ALL_CAST.forEach(name => {
    const wrongHere = wrongGuesses[r][c].has(name);
    const usedTwice = (miniUsed[name]||0) >= 2;
    const struckOut = wrongHere || usedTwice;

    const tag = document.createElement('div');
    tag.className = 'cast-tag' + (struckOut?' strikeout':'');
    tag.textContent = name;
    roster.appendChild(tag);

    if (!struckOut) {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      sel.appendChild(opt);
    }
  });
}

// ============================================================
// SUBMIT ANSWER
// ============================================================
function submitAnswer() {
  if (!activeCell) return;
  const {r,c} = activeCell;
  const name = document.getElementById('answer-select').value;
  if (!name) return;

  const valid = VALID_ANSWERS[r][c];
  const isCorrect = valid.includes(name);

  if (isCorrect) {
    // Flash correct
    const inner = document.getElementById('modal-inner');
    const pc = players[currentPlayer].color;
    inner.innerHTML = `<div class="modal-correct" style="color:${pc}">CORRECT!</div>`;
    setTimeout(()=>{
      commitCorrect(r,c,name);
    }, 900);
  } else {
    // Wrong ‚Äî cross out in list, switch player, free pick
    wrongGuesses[r][c].add(name);
    buildModalCastList(r,c); // refresh strikeouts

    // Flash wrong briefly on the dropdown
    const sel = document.getElementById('answer-select');
    sel.style.borderColor = '#e85d5d';
    sel.style.color = '#e85d5d';
    setTimeout(()=>{ sel.style.borderColor=''; sel.style.color=''; },600);

    // Switch turn, free pick
    forcedMacro = null;
    currentPlayer = 1-currentPlayer;
    closeModal();
    updateUI();
  }
}

function commitCorrect(r,c,name) {
  const photo = CAST_PHOTOS[name]||'';
  board[r][c] = {player:currentPlayer, name, photo};
  renderCell(r,c);

  const mr=Math.floor(r/3), mc=Math.floor(c/3);
  const miniResult = checkMiniTTT(mr,mc);
  let miniJustWon = false;
  if (miniResult!==null && miniWon[mr][mc]===null) {
    miniWon[mr][mc] = miniResult;
    scores[miniResult]++;
    renderMiniWon(mr,mc,miniResult);
    miniJustWon = true;
    if (scores[0]>=3||scores[1]>=3) { closeModal(); showWinScreen(miniResult); return; }
  }

  const nextMr=r%3, nextMc=c%3;
  if (miniJustWon) { forcedMacro=null; }
  else if (miniWon[nextMr][nextMc]!==null||isMiniGridFull(nextMr,nextMc)) { forcedMacro=null; }
  else { forcedMacro={mr:nextMr,mc:nextMc}; }

  currentPlayer = 1-currentPlayer;
  closeModal();
  updateUI();
}

function closeModal() {
  document.getElementById('modal-overlay').classList.remove('open');
  activeCell = null;
}

// ============================================================
// RENDER CELL
// ============================================================
function renderCell(r,c) {
  const cell = document.getElementById(`cell-${r}-${c}`);
  const data = board[r][c];
  if (!data) return;
  cell.classList.add('claimed');
  cell.innerHTML = '';
  if (data.photo) {
    const img = document.createElement('img'); img.className='cell-photo'; img.src=data.photo; img.alt=data.name;
    cell.appendChild(img);
    const g = document.createElement('div'); g.className='cell-gradient'; cell.appendChild(g);
  } else {
    cell.style.background=`color-mix(in srgb, ${players[data.player].color} 22%, var(--surface))`;
  }
  const n = document.createElement('div'); n.className='cell-name'; n.textContent=data.name; cell.appendChild(n);
  const b = document.createElement('div'); b.className='cell-border-overlay'; b.style.setProperty('--claim-color',players[data.player].color); cell.appendChild(b);
}

// ============================================================
// TTT LOGIC
// ============================================================
function checkMiniTTT(mr,mc) {
  const g = Array.from({length:3},(_,i)=>Array.from({length:3},(_,j)=>{ const d=board[mr*3+i][mc*3+j]; return d?d.player:null; }));
  const lines=[[[0,0],[0,1],[0,2]],[[1,0],[1,1],[1,2]],[[2,0],[2,1],[2,2]],[[0,0],[1,0],[2,0]],[[0,1],[1,1],[2,1]],[[0,2],[1,2],[2,2]],[[0,0],[1,1],[2,2]],[[0,2],[1,1],[2,0]]];
  for (const line of lines) { const v=line.map(([ri,ci])=>g[ri][ci]); if (v[0]!==null&&v[0]===v[1]&&v[1]===v[2]) return v[0]; }
  return null;
}

function isMiniGridFull(mr,mc) {
  for (let i=0;i<3;i++) for (let j=0;j<3;j++) if (!board[mr*3+i][mc*3+j]) return false;
  return true;
}

// ============================================================
// RENDER MINI WON
// ============================================================
function renderMiniWon(mr,mc,player) {
  const color = players[player].color;
  for (let i=0;i<3;i++) for (let j=0;j<3;j++) {
    const cell = document.getElementById(`cell-${mr*3+i}-${mc*3+j}`);
    cell.style.outline = `3px solid ${color}`;
    cell.style.background = `color-mix(in srgb, ${color} 18%, var(--surface))`;
    const ov = document.createElement('div'); ov.className='mini-won-overlay';
    ov.style.background=`color-mix(in srgb, ${color} 20%, transparent)`;
    ov.style.color=color; ov.style.fontFamily="'Bebas Neue',sans-serif";
    if (i===1&&j===1) { ov.style.fontSize='13px'; ov.textContent=players[player].name.substring(0,4).toUpperCase(); }
    cell.appendChild(ov);
  }
}

// ============================================================
// WIN SCREEN
// ============================================================
function showWinScreen(player) {
  const ws=document.getElementById('win-screen');
  document.getElementById('win-name').textContent=players[player].name.toUpperCase();
  document.getElementById('win-name').style.color=players[player].color;
  document.getElementById('win-name').style.textShadow=`0 0 60px ${players[player].color}`;
  ws.classList.add('open');
}

// Click outside modal to close
document.getElementById('modal-overlay').addEventListener('click',function(e){ if(e.target===this) closeModal(); });
</script>
</body>
</html>
